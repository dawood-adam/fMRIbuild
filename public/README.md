# fMRIbuild Workflow Bundle

This bundle contains a CWL (Common Workflow Language) workflow generated by fMRIbuild.

## Contents

- `workflows/main.cwl` - The main workflow file
- `cwl/` - Tool definitions used by the workflow

## Prerequisites

### Installing cwltool

#### Linux / macOS

```bash
pip install cwltool
```

#### Windows (via WSL)

CWL workflows require a Unix-like environment. On Windows, you'll need to use WSL (Windows Subsystem for Linux):

1. **Install WSL** (if not already installed):
   ```powershell
   wsl --install
   ```
   Restart your computer when prompted.

2. **Open WSL terminal** and install Python/pip:
   ```bash
   sudo apt update
   sudo apt install python3 python3-pip
   ```

3. **Install cwltool**:
   ```bash
   pip install cwltool
   ```

### Docker (Required)

Most neuroimaging tools run inside Docker containers. Install Docker:

- **Linux**: https://docs.docker.com/engine/install/
- **macOS**: https://docs.docker.com/desktop/install/mac-install/
- **Windows**: https://docs.docker.com/desktop/install/windows-install/
    - Ensure WSL 2 backend is enabled

## Setup

### 1. Extract the Workflow Bundle

#### Linux / macOS

```bash
unzip workflow_bundle.zip -d my_workflow
cd my_workflow
```

#### Windows (WSL)

First, copy the zip file to your WSL filesystem for better performance:

```bash
# From within WSL, copy from Windows filesystem
cp /mnt/c/Users/YourUsername/Downloads/workflow_bundle.zip ~/
unzip workflow_bundle.zip -d my_workflow
cd my_workflow
```

### 2. Make the Workflow Executable

```bash
chmod +x workflows/main.cwl
```

### 3. Generate an Input Template

Use cwltool to generate a YAML template for your workflow inputs:

```bash
cwltool --make-template workflows/main.cwl > inputs.yml
```

This creates an `inputs.yml` file with all required and optional inputs. Edit this file to specify your input files and parameters.

### 4. Edit the Input Template

Open `inputs.yml` in a text editor and fill in the required values:

```yaml
# Example inputs.yml
input_file:
  class: File
  path: /path/to/your/brain_image.nii.gz

output: "brain_extracted"

# Optional parameters (remove or set to null if not needed)
frac: 0.5
mask: true
```

**Notes:**
- File paths should be absolute paths or relative to where you run cwltool
- Optional parameters can be removed or set to `null`
- For record-type inputs (like `exclusive`), provide the appropriate structure

## Running the Workflow

### Basic Execution

```bash
cwltool workflows/main.cwl inputs.yml
```

### With Specific Output Directory

```bash
cwltool --outdir ./results workflows/main.cwl inputs.yml
```

### Verbose Output (for debugging)

```bash
cwltool --debug workflows/main.cwl inputs.yml
```

## Troubleshooting

### "Docker not found" Error

Ensure Docker is running:
```bash
docker --version
sudo systemctl start docker  # Linux
```

### Permission Denied on Docker

Add your user to the docker group:
```bash
sudo usermod -aG docker $USER
# Log out and back in for changes to take effect
```

### WSL: Slow File Access

For best performance in WSL, keep your workflow files in the Linux filesystem (`~/`) rather than the Windows mount (`/mnt/c/`).

### Validation Errors

Validate your workflow before running:
```bash
cwltool --validate workflows/main.cwl
```

## Resources

- [CWL User Guide](https://www.commonwl.org/user_guide/)
- [cwltool Documentation](https://github.com/common-workflow-language/cwltool)
- [FSL Documentation](https://fsl.fmrib.ox.ac.uk/fsl/fslwiki)
- [fMRIbuild GitHub](https://github.com/KunaalAgarwal/fMRIbuild)